/*!
 * Lichen App Controllers. 
 * Version: 0.0.2
 *
 * http://www.indicia.org.uk/
 *
 * Author 2015 Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 */

function checkForUpdates(){var a="controllerVersion",b=app.settings(a);return null==b?void app.settings(a,app.CONF.VERSION):void(b!=app.CONF.VERSION&&(_log("app: controller version differs. Updating the app.",app.LOG_INFO),app.storage.remove("species"),app.storage.tmpClear(),app.settings(a,app.CONF.VERSION)))}!function(a){app.controller=app.controller||{},app.controller.about={pagecontainershow:function(){var b=a("#app-version-template").html(),c=a("#app-version-placeholder"),d=Handlebars.compile(b);c.html(d({version:app.CONF.VERSION})),c.trigger("create")}}}(jQuery),function(a){checkForUpdates(),app.initialise(),a(document).on("pagecreate",function(a){if(browserDetect("Safari")&&null!=jQuery.mobile.activePage){var b=a.target.id,c=null,d=jQuery.mobile.activePage.attr("data-external-page");null==d&&(c="#"+jQuery.mobile.activePage.attr("id")),fixPageBackButtons(c,b)}}),app.record.db.getData=function(a,b,c){function d(a){for(var c=new FormData,d=0;d<a.length;d++)if("file"==a[d].type){var e=a[d].value,f=e.split(";")[0].split(":")[1],g=f.split("/")[1];c.append(a[d].name,dataURItoBlob(e,f),"pic."+g)}else{var h=a[d].name,i=a[d].value;c.append(h,i)}b(c)}this.get(a,d,c)}}(app.$||jQuery),function(){app.controller=app.controller||{},app.controller.compass={lastUpdate:0,UPDATE_TIME_DIFF:10,pagecreate:function(){_log("compass: pagecreate",app.LOG_DEBUG),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(a){var b=new Date,c=b.getTime(),d=app.controller.compass.lastUpdate+app.controller.compass.UPDATE_TIME_DIFF;c>d&&(app.controller.compass.lastUpdate=c,app.controller.compass.rotateRose(a))})},rotateRose:function(a){var b,c,d=document.getElementById("windrose");a.webkitCompassHeading?(b=a.webkitCompassHeading,d.style.WebkitTransform="rotate(-"+b+"deg)"):(b=a.alpha,c=b,window.chrome||(c=b-270)),_log("compass: rotate "+b,app.LOG_DEBUG),d.style.Transform="rotate("+b+"deg)",null!=c&&(d.style.WebkitTransform="rotate("+c+"deg)"),d.style.MozTransform="rotate(-"+b+"deg)"}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.list={CONF:{PROB_DATA_SRC:"",SPECIES_DATA_SRC:""},DEFAULT_SORT:"taxonomic",pagecreate:function(){_log("list: pagecreate."),this.loadSpeciesData()},pagecontainershow:function(){_log("list: pagecontainershow.");var b="Lichen IDs",c=app.storage.tmpGet(app.controller.record.RECORDING);if(c){for(var d=app.storage.tmpGet(app.controller.record.ZONE),e=app.storage.tmpGet(app.controller.record.TYPE),f=app.controller.tree_part.zones[e],g=null,h=0;h<f.length;h++)if(f[h].zone==d){b=f[h].title,g=h;break}a("#zone-next-button").show(),app.controller.list.setNextButton(f,g)}else a("#zone-next-button").hide();a("#list_heading").text(b),app.controller.list.renderList(function(){a(".species-list-button").each(function(){var b=a(this).data("speciesid");a(this).on("click",function(){app.controller.list.setCurrentSpecies(b)})}),a(".species-list-checkbox-button").each(function(){var b=a(this).data("speciesid");a(this).on("click",function(){app.controller.list.setCurrentSpecies(b)})});var b=app.storage.tmpGet(app.controller.record.RECORDING);b&&a(".species-list-checkbox-button > div > input").on("change",function(){var b=app.storage.tmpGet(app.controller.record.ZONE),c=a(this).data("speciesid"),d=a(this).is(":checked");app.controller.list.setSavedZoneSpecies(b,c,d)})})},setNextButton:function(b,c){var d=a("#zone-next-button");d.unbind("click"),d.on("click",function(){var b=a(this).data("zone");app.storage.tmpSet(app.controller.record.ZONE,b)}),++c<b.length?(d.data("zone",b[c].zone),d.text(b[c].title),d.on("click",app.controller.list.pagecontainershow)):(d.text("Finish"),d.on("click",function(){history.back()}))},loadSpeciesData:function(){app.storage.is("species")?app.data.species=app.storage.get("species"):(app.navigation.message("Loading IDs data for the first time.."),a.ajax({url:this.CONF.SPECIES_DATA_SRC,dataType:"jsonp",async:!1,success:function(a){app.navigation.message("Done loading IDs data"),app.data.species=a,app.storage.set("species",a),app.controller.list.renderList()}}))},getAllSpecies:function(){return app.record.inputs.get(app.controller.record.SPECIES)||{trunk:{},branch:{}}},setAllSpecies:function(a){app.record.inputs.set(app.controller.record.SPECIES,a)},getSavedZoneSpecies:function(a){var b=app.storage.tmpGet(app.controller.record.TYPE),c=app.storage.tmpGet(app.controller.record.PART),d=this.getAllSpecies();return d[b][c]?d[b][c][a]||[]:[]},setSavedZoneSpecies:function(a,b,c){var d=this.getSavedZoneSpecies(a);if(c)-1==d.indexOf(b)&&d.push(b);else{var e=d.indexOf(b);-1!=e&&d.splice(e)}var f=app.storage.tmpGet(app.controller.record.TYPE),g=app.storage.tmpGet(app.controller.record.PART),h=this.getAllSpecies();null==h[f][g]&&(h[f][g]={}),h[f][g][a]=d,this.setAllSpecies(h)},categorizeSpecies:function(a){for(var b=[],c=[],d=0;d<a.length;d++)for(var e=0;e<app.data.species.length;e++)if(app.data.species[e].id==a[d]){"tolerant"==app.data.species[e].type?c.push(a[d]):b.push(a[d]);break}return{sensitive:b,tolerant:c}},renderList:function(a){var b=this.DEFAULT_SORT,c=app.data.species;null!=c&&this.renderListCore(c,b,a)},renderListCore:function(a,b,c){function d(a,b){return a.taxon>b.taxon}for(var e={bushy:[],leafy:[],granular:[]},f=0;f<a.length;f++)e[a[f].growth_form].push(a[f]);e.bushy.sort(d),e.leafy.sort(d),e.granular.sort(d);var g=e.bushy;g=g.concat(e.leafy),g=g.concat(e.granular),null!=a&&(app.controller.list.printList(g),null!=c&&c())},printList:function(b){var c=b,d=app.storage.tmpGet(app.controller.record.RECORDING),e=null;if(d){e=a("#list-record-template").html(),c=objClone(b);for(var f=app.storage.tmpGet(app.controller.record.ZONE),g=this.getSavedZoneSpecies(f),h=0;h<c.length;h++)c[h].checked=-1!=g.indexOf(c[h].id)?"checked":""}else e=a("#list-template").html();var i=a("#list-placeholder"),j=Handlebars.compile(e);i.html(j({species:c})),i.trigger("create")},getChecked:function(){app.record.get()},getSpecies:function(){return app.settings("listSpecies")||{}},setSpecies:function(a){return app.settings("listSpecies",a)},CURRENT_SPECIES_KEY:"currentSpecies",getCurrentSpecies:function(){return app.storage.tmpGet(this.CURRENT_SPECIES_KEY)},setCurrentSpecies:function(a){for(var b={},c=0;c<app.data.species.length;c++)if(app.data.species[c].id==a){b=app.data.species[c];break}return app.storage.tmpSet(this.CURRENT_SPECIES_KEY,b)},getCurrentFilters:function(){return app.settings(this.FILTERS_KEY)||[]},getFilterCurrentGroup:function(a){for(var b=this.getCurrentFilters(),c=[],d=0;d<b.length;d++)b[d].group==a.group&&c.push(b[d]);return c},getSortType:function(){return app.settings(this.SORT_KEY)||this.DEFAULT_SORT},setSortType:function(a){return app.settings(this.SORT_KEY,a)},getFilterById:function(a){for(var b=0;b<this.filters.length;b++)if(this.filters[b].id==a)return this.filters[b];return null},sortList:function(a,b,c){switch(b){case"probability_sort":app.controller.list.prob.runFilter(a,function(){a.sort(app.controller.list.prob.sort),c(a)});break;case"taxonomic":a.sort(function(a,b){return a=a.taxon.toLowerCase(),b=b.taxon.toLowerCase(),a==b?0:a>b?1:-1});break;case"taxonomic_r":a.sort(function(a,b){return a=a.taxon.toLowerCase(),b=b.taxon.toLowerCase(),a==b?0:b>a?1:-1});break;case this.DEFAULT_SORT+"_r":a.sort(function(a,b){return a=a.common_name.toLowerCase(),b=b.common_name.toLowerCase(),a==b?0:b>a?1:-1});break;case this.DEFAULT_SORT:default:a.sort(function(a,b){return a=a.common_name.toLowerCase(),b=b.common_name.toLowerCase(),a==b?0:a>b?1:-1})}c(a)},download:function(){var b="offline",c=app.settings(b);if(null==c||!c.downloaded&&!c.dontAsk){var d="download-button",e="download-cancel-button",f="download-checkbox",g='Start downloading the app for offline use?</br><label><input id="'+f+'" type="checkbox" name="checkbox-0 ">Don\'t ask again</label> </br><a href="#" id="'+d+'"class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Download</a><a href="#" id="'+e+'"class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow">Cancel</a>';app.navigation.popup(g),a("#"+d).on("click",function(){_log("list: starting appcache downloading process."),setTimeout(function(){function a(){c={downloaded:!0,dontAsk:!1},app.settings(b,c),app.navigation.closePopup(),location.reload()}function d(){_log("list: ERROR appcache.")}startManifestDownload("appcache",114,app.CONF.APPCACHE_LOADER_URL,a,d)},500)}),a("#"+e).on("click",function(){_log("list: appcache dowload canceled.");var d=a("#"+f).prop("checked");c={downloaded:!1,dontAsk:d},app.settings(b,c)})}}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.login={CONF:{URL:"",TIMEOUT:2e4},pagecontainershow:function(){},login:function(){_log("login: start.");var b=jQuery("#login-form"),c={email:b.find("input[name=email]").val(),password:b.find("input[name=password]").val(),appname:app.auth.CONF.APPNAME,appsecret:app.auth.CONF.APPSECRET};a.ajax({url:this.CONF.URL,type:"POST",data:c,callback_data:c,dataType:"text",timeout:this.CONF.TIMEOUT,success:this.onLoginSuccess,error:this.onLoginError,beforeSend:this.onLogin})},onLogin:function(){a.mobile.loading("show")},onLoginSuccess:function(b){_log("login: success.");var c=b&&b.split(/\r\n|\r|\n/g);if(c&&c.length>=3&&c[0].length>0)var d={secret:c[0],name:c[1]+" "+c[2],email:this.callback_data.email};a.mobile.loading("hide"),app.controller.login.setLogin(d),a.mobile.changePage("#user")},onLoginError:function(b,c,d){_log("login: ERROR "+b.status+" "+d+"."),_log(b.responseText),a.mobile.loading("show",{text:"Wrong email or password. Please double-check and try again.",theme:"b",textVisible:!0,textonly:!0}),setTimeout(function(){a.mobile.loading("hide")},3e3)},logout:function(){app.auth.removeUser()},setLogin:function(b){a.isEmptyObject(b)?(_log("login: logged out."),app.auth.removeUser()):(_log("login: logged in."),app.auth.setUser(b))},getLoginState:function(){return app.auth.isUser()}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.record={RECORDING:"recording",SPECIES:"species",TYPE:"recording_type",PART:"recording_part",ZONE:"recording_zone",types:{branch:[{type:"branch",part:"1",title:"Branch #1"},{type:"branch",part:"2",title:"Branch #2"},{type:"branch",part:"3",title:"Branch #3"},{type:"branch",part:"4",title:"Branch #4"},{type:"branch",part:"5",title:"Branch #5"}],trunk:[{type:"trunk",part:"1",title:"Trunk #1"},{type:"trunk",part:"2",title:"Trunk #2"},{type:"trunk",part:"3",title:"Trunk #3"},{type:"trunk",part:"4",title:"Trunk #4"},{type:"trunk",part:"5",title:"Trunk #5"}]},pagecreate:function(){_log("record: pagecreate."),this.saveDate(),app.controller.list.loadSpeciesData(),a("#results-button").on("click",function(){var b=app.controller.record.valid();b==app.TRUE&&a("body").pagecontainer("change","#results")})},pagecontainershow:function(a,b){_log("record: pagecontainershow.");var c=b.prevPage[0].id;switch(c){case"welcome":}this.renderButtons()},renderButtons:function(){var b=a("#type-template").html(),c=this.types.branch,d=a("#branch-placeholder"),e=Handlebars.compile(b);d.html(e(c)),d.trigger("create"),c=this.types.trunk,d=a("#trunk-placeholder"),e=Handlebars.compile(b),d.html(e(c)),d.trigger("create"),a(".record-button").on("click",function(){var b=a(this).data("type"),c=a(this).data("part");app.storage.tmpSet(app.controller.record.TYPE,b),app.storage.tmpSet(app.controller.record.PART,c)}),this.setResultsOnButtons(this.types.branch),this.setResultsOnButtons(this.types.trunk)},setResultsOnButtons:function(b){for(var c=app.controller.list.getAllSpecies(),d=0;d<b.length;d++){var e=b[d].type,f=c[e],g=f[b[d].part];if(null!=g){for(var h=Object.keys(g),i=0,j=0;j<h.length;j++)g[h[j]].length>0&&i++;var k=a('a[data-type="'+e+'"][data-part="'+(d+1)+'"]');switch(i){case 1:k.find(".first-progress").addClass("progress"),k.find(".half-progress").removeClass("progress"),k.find(".full-progress").removeClass("progress");break;case 2:k.find(".first-progress").addClass("progress"),k.find(".half-progress").addClass("progress"),k.find(".full-progress").removeClass("progress");break;case 3:k.find(".first-progress").addClass("progress"),k.find(".half-progress").addClass("progress"),k.find(".full-progress").addClass("progress");break;default:i>3&&_log("record: Too many modified ones.",app.LOG_ERROR),k.find(".first-progress").removeClass("progress"),k.find(".half-progress").removeClass("progress"),k.find(".full-progress").removeClass("progress")}}}},clear:function(){_log("record: clearing recording page."),app.record.clear(),this.saveDate()},valid:function(){var b=this.validateInputs();if(b.length>0){for(var c="<p>The following is still missing:</p><ul>",d=0;d<b.length;d++)c+="<li>"+b[d].name+"</li>";return c+="</ul>",app.navigation.message(c),app.FALSE}var e=app.geoloc.valid();return e==app.ERROR||e==app.FALSE?(a("body").pagecontainer("change","#sref"),app.FALSE):app.TRUE},validateInputs:function(){var a=[];return app.record.inputs.is("sample:date")||a.push({id:"sample:date",name:"Date"}),app.record.inputs.is("sample:entered_sref")||a.push({id:"sample:entered_sref",name:"Location"}),a},saveSref:function(a){if(null==a)return app.ERROR;var b=a.lat+", "+a.lon,c="4326",d=a.acc;app.record.inputs.set(app.record.inputs.KEYS.SREF,b),app.record.inputs.set(app.record.inputs.KEYS.SREF_SYSTEM,c),app.record.inputs.set(app.record.inputs.KEYS.SREF_ACCURACY,d)},saveInput:function(b){if(null==b&&""==b)return _log("record: ERROR, no input name provided."),app.ERROR;var c=document.getElementById(b),d=a(c).val();""!=d&&app.record.inputs.set(b,d)},saveSpecies:function(){var b=app.controller.list.getCurrentSpecies();if(null!=b&&null!=b.warehouse_id&&""!=b.warehouse_id){var c="occurrence:taxa_taxon_list_id",d=b.warehouse_id;app.record.inputs.set(c,d),a("#record_heading").text(b.common_name)}else _log("record: ERROR no species was found. Nothing attached to the recording.")},saveDate:function(){var b=new Date,c=("0"+b.getDate()).slice(-2),d=("0"+(b.getMonth()+1)).slice(-2),e=b.getFullYear()+"-"+d+"-"+c,f="sample:date",g=document.getElementById(f);a(g).val(e),app.record.inputs.set(f,e)},gpsButtonState:function(b){var c=a("#sref-top-button");switch(b){case"running":c.addClass("running"),c.removeClass("done"),c.removeClass("none");break;case"done":c.addClass("done"),c.removeClass("running"),c.removeClass("none");break;case"none":c.addClass("none"),c.removeClass("done"),c.removeClass("running");break;default:_log("record: ERROR no such GPS button state.")}}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.register={CONF:{URL:"",TIMEOUT:2e4},pagecontainershow:function(){a("#terms-agreement").click(function(){var b=a("#register-button");a(this).prop("checked")?b.prop("disabled",!1):b.prop("disabled",!0)})},register:function(){_log("register: start.");var b=document.getElementById("register-form"),c=new FormData(b);c.append("appname",app.auth.CONF.APPNAME),c.append("appsecret",app.auth.CONF.APPSECRET),a.ajax({url:this.CONF.URL,type:"POST",data:c,dataType:"text",contentType:!1,processData:!1,timeout:this.CONF.TIMEOUT,success:this.onLoginSuccess,error:this.onLoginError,beforeSend:this.onLogin})},onLogin:function(){a.mobile.loading("show")},onLoginSuccess:function(){_log("register: success."),a.mobile.loading("hide")},onLoginError:function(b,c,d){_log("register: ERROR "+b.status+" "+d),_log(b.responseText),a.mobile.loading("hide")}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.results={y:null,x:null,trunk_path:null,branch_path:null,trunk_result:null,branch_result:null,pagecreate:function(){_log("results: pagecreate",app.LOG_DEBUG),a("#send-button").on("click",app.controller.results.send),a("#save-button").on("click",app.controller.results.save)},pagecontainershow:function(){_log("results: pagecontaintershow",app.LOG_DEBUG),this.drawgraph();var b=app.controller.list.getAllSpecies(),c=this.calculateLIS(b.trunk),d=this.calculateLIS(b.branch),e=(3.6666666-c)/3.33333,f=(3.4-d)/4;_log("results: trunk_lis: "+c+", branch_lis: "+d),a("#results-branch-lis").text(d.toFixed(1)),a("#results-trunk-lis").text(c.toFixed(1)),a("#results-branch-naqi").text(f.toFixed(1)),a("#results-trunk-naqi").text(e.toFixed(1)),this.add_trunk_results(c),this.add_branch_results(d)},calculateLIS:function(a){function b(a,b){if(null==b)return!1;var c=app.controller.list.categorizeSpecies(b);return"sensitive"==a?c.sensitive.length>0:"tolerant"==a?c.tolerant.length>0:void _log("results: no such lichen type.",app.LOG_ERROR)}for(var c=0,d=0,e=Object.keys(a),f=0;f<e.length;f++)for(var g=Object.keys(a[e[f]]),h=0;h<g.length;h++){var i=a[e[f]][g[h]];b("tolerant",i)&&c++,b("sensitive",i)&&d++}return(d-c)/e.length},send:function(){function b(b){a.mobile.loading("hide");var c="<center><h3>Sorry!</h3></center><p>"+b.message+"</p>";app.navigation.message(c)}function c(){a.mobile.loading("hide"),app.navigation.message("<center><h2>Submitted successfully. </br>Thank You!</h2></center>"),app.controller.record.clear(),setTimeout(function(){a("body").pagecontainer("change","#welcome")},3e3)}function d(){a.mobile.loading("hide"),app.navigation.message("<center><h2>No Internet. Record saved.</h2></center>"),setTimeout(function(){a("body").pagecontainer("change","#welcome")},3e3)}a.mobile.loading("show"),navigator.onLine?app.controller.results.processOnline(c,b):app.controller.results.processOffline(d,b)},save:function(){function b(){a.mobile.loading("hide"),app.navigation.message("<center><h2>Record saved.</h2></center>"),app.controller.record.clear(),setTimeout(function(){a("body").pagecontainer("change","#welcome")},3e3)}function c(b){a.mobile.loading("hide");var c="<center><h3>Sorry!</h3></center><p>"+b.message+"</p>";app.navigation.message(c),a("body").pagecontainer("change","#welcome")}a.mobile.loading("show"),app.controller.results.processOffline(b,c)},processOnline:function(a,b){_log("record: process online.");var c=function(c){function d(){app.record.db.remove(c),null!=a&&a()}app.record.clear(),app.io.sendSavedRecord(c,d,b)};app.record.db.save(c,b)},processOffline:function(a,b){_log("record: process offline");var c=function(){app.record.clear(),null!=a&&a()};app.record.db.save(c,b)},drawgraph:function(){{var b=a("#graph-container"),c=[40,10,80,20],d=b.width()-c[1]-c[3],e=b.height()-c[0]-c[2],f=[3.6,.3,-3],g=[3.4,-.4,-4.6];d3.format(".0f")}this.x=d3.scale.linear().domain([0,2]).range([0,d]),this.y=d3.scale.linear().domain([-3,4]).range([e,0]);var h=d3.svg.line().x(function(a,b){return app.controller.results.x(b)}).y(function(a){return app.controller.results.y(a)}),i=d3.select("#graph-container").append("svg:svg").attr("width",d+c[1]+c[3]).attr("height",e+c[0]+c[2]).append("svg:g").attr("transform","translate("+c[3]+","+c[0]+")"),j=i.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","0%").attr("x2","100%").attr("spreadMethod","pad");j.append("svg:stop").attr("offset","0%").attr("stop-color","lightgreen").attr("stop-opacity",1),j.append("svg:stop").attr("offset","30%").attr("stop-color","lightgrey").attr("stop-opacity",1),j.append("svg:stop").attr("offset","50%").attr("stop-color","#FFFF66").attr("stop-opacity",1),j.append("svg:stop").attr("offset","70%").attr("stop-color","#FF6666").attr("stop-opacity",1),i.append("svg:rect").attr("width",d).attr("height",e).style("fill","url(#gradient)");var k=d3.svg.axis().scale(this.x).tickValues([.1,.5,1,1.5,2]);i.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(k);var l=d3.svg.axis().scale(this.y).ticks(4).tickSize(-d).orient("left");i.append("svg:g").style("stroke-dasharray","1, 1").attr("class","y axis").call(l),i.append("text").attr("y",.7*-c[0]).attr("x",0).attr("dy","1em").style("text-anchor","middle").text("(LIS)"),i.append("text").attr("y",e+c[3]).attr("x",d-c[0]).attr("dy","1em").style("text-anchor","middle").text("(NAQI)"),i.append("clipPath").attr("id","clip").append("rect").attr("width",d).attr("height",e),this.trunk_path=i.append("svg:path").attr("class","trunk").attr("d",h(f)).attr("clip-path","url(#clip)"),this.branch_path=i.append("svg:path").attr("class","branch").style("stroke-dasharray","5, 5, 5, 9, 9").attr("d",h(g)).attr("clip-path","url(#clip)");var m=this.branch_path.node().getPointAtLength(0);this.branch_result=i.append("path").attr("class","branch").attr("d",d3.svg.symbol().type("circle")).attr("class","branch").attr("transform",function(){return"translate("+m.x+","+m.y+")"}),m=this.trunk_path.node().getPointAtLength(0),this.trunk_result=i.append("path").attr("class","trunk").attr("d",d3.svg.symbol().type("triangle-up")).attr("class","trunk").attr("transform",function(){return"translate("+m.x+","+m.y+")"})},add_branch_results:function(a){this.add_results(this.branch_path.node(),this.branch_result,a)},add_trunk_results:function(a){this.add_results(this.trunk_path.node(),this.trunk_result,a)},add_results:function(a,b,c){var d=0,e={y:0};do d++,e=a.getPointAtLength(d),b.transition().duration(2e3).attr("transform",function(){return"translate("+e.x+","+e.y+")"});while(e.y<this.y(c))}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.species={pagecreate:function(){},pagecontainershow:function(){_log("species: pagecontainershow.");var b=a("#species-template").html(),c=a("#species-placeholder"),d=Handlebars.compile(b),e=app.controller.list.getCurrentSpecies();c.html(d(e)),c.trigger("create")}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.sref={saveData:!1,pagecreate:function(){if(_log("sref: pagecreate."),"undefined"==typeof google){a("#sref-opts").disableTab(1);var b="&"+(new Date).getTime();loadScript("http://maps.googleapis.com/maps/api/js?sensor=false&callback=app.controller.sref.initializeMap"+b)}},pagecontainerbeforeshow:function(){app.controller.sref.renderGPStab("init"),this.saveData=!1},pagecontainerbeforechange:function(a,b){if(_log("sref: pagecontainerbeforechange."),"object"==typeof b.toPage&&null!=b.toPage[0]&&(nextPage=b.toPage[0].id,this.saveData&&-1!=this.accuracy)){var c=this.saveSref();switch(nextPage){case"record":app.controller.record.saveSref(c);break;default:_log("sref: ERROR changing to unknown page.")}}},saveSref:function(){var a={lat:this.latitude,lon:this.longitude,acc:this.accuracy};return app.settings("location",a),app.geoloc.set(a.lat,a.lon,a.acc),a},save:function(){_log("sref: saving Sref."),this.saveData=!0},map:{},latitude:null,longitude:null,accuracy:-1,set:function(a,b,c){this.latitude=a,this.longitude=b,this.accuracy=c},get:function(){return{lat:this.latitude,lon:this.longitude,acc:this.accuracy}},updateCoordinateDisplay:function(b,c,d){var e="Your coordinates: "+b+", "+c+" (Accuracy: "+d+")";a("#coordinates").text(e)},renderGPStab:function(b,c){var d=null,e=a("#sref-gps-placeholder"),f="",g={};switch(b){case"init":var h=app.controller.sref.get();-1==h.acc?h=null:c=h,d=a("#sref-gps").html();break;case"running":d=a("#sref-gps-running").html();break;case"finished":d=a("#sref-gps-finished").html();break;default:_log("sref: unknown render gps tab.")}if(null!=c){var i=new LatLonE(c.lat,c.lon,GeoParams.datum.OSGB36),j=OsGridRef.latLonToOsGrid(i);f=j.toString(),c.gref=f,g.location=c}var k=Handlebars.compile(d);e.html(k(g)),e.trigger("create"),a("#gps-start-button").on("click",app.controller.sref.startGeoloc),a("#gps-stop-button").on("click",app.controller.sref.stopGeoloc),a("#gps-improve-button").on("click",app.controller.sref.startGeoloc)},startGeoloc:function(){function b(a){var b=app.controller.sref.get();-1==b.acc||a.acc<=b.acc?(b=a,app.controller.sref.set(a.lat,a.lon,a.acc)):a=b,app.controller.sref.renderGPStab("running",a)}function c(b){a.mobile.loading("hide"),app.controller.sref.set(b.lat,b.lon,b.acc),app.controller.sref.renderGPStab("finished",b)}function d(b){a.mobile.loading("show",{text:"Sorry! "+b.message+".",theme:"b",textVisible:!0,textonly:!0}),setTimeout(function(){a.mobile.loading("hide")},5e3),app.controller.sref.renderGPStab("init")}a.mobile.loading("show"),app.geoloc.run(b,c,d);var e=null,f=app.controller.sref.get();-1!=f.acc&&(e=f),app.controller.sref.renderGPStab("running",e)},stopGeoloc:function(){a.mobile.loading("hide"),app.geoloc.stop(),app.controller.sref.renderGPStab("init")},initializeMap:function(){function b(a){var b={lat:a.lat(),lon:a.lng()};app.controller.sref.set(b.lat,b.lon,1),c("#map-message",b)}function c(b,c){var d=new LatLonE(c.lat,c.lon,GeoParams.datum.OSGB36),e=OsGridRef.latLonToOsGrid(d),f=e.toString(),g=a(b);g.removeClass(),g.addClass("success-message"),g.empty().append("<p>Grid Ref:<br/>"+f+"</p>")}_log("sref: initialising map.");var d=a("#map-canvas")[0],e={zoom:5,center:new google.maps.LatLng(57.686988,-14.763319),zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL},panControl:!1,linksControl:!1,streetViewControl:!1,overviewMapControl:!1,scaleControl:!1,rotateControl:!1,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR},styles:[{featureType:"landscape",stylers:[{hue:"#FFA800"},{saturation:0},{lightness:0},{gamma:1}]},{featureType:"road.highway",stylers:[{hue:"#53FF00"},{saturation:-73},{lightness:40},{gamma:1}]},{featureType:"road.arterial",stylers:[{hue:"#FBFF00"},{saturation:0},{lightness:0},{gamma:1}]},{featureType:"road.local",stylers:[{hue:"#00FFFD"},{saturation:0},{lightness:30},{gamma:1}]},{featureType:"water",stylers:[{saturation:43},{lightness:-11},{hue:"#0088ff"}]},{featureType:"poi",stylers:[{hue:"#679714"},{saturation:33.4},{lightness:-25.4},{gamma:1}]}]};this.map=new google.maps.Map(d,e);var f=new google.maps.Marker({position:new google.maps.LatLng(-25.363,131.044),map:app.controller.sref.map,icon:"http://maps.google.com/mapfiles/marker_green.png",draggable:!0});f.setVisible(!1);var g=null;if(google.maps.event.addListener(this.map,"click",function(a){g=setTimeout(function(){var c=a.latLng;f.setPosition(c),f.setVisible(!0),b(c)},200)}),google.maps.event.addListener(this.map,"dblclick",function(){clearTimeout(g)}),google.maps.event.addListener(f,"dragend",function(){var a=f.getPosition();b(a)}),null!=this.latitude&&null!=this.longitude){var h=new google.maps.LatLng(this.latitude,this.longitude);app.controller.sref.map.setCenter(h),app.controller.sref.map.setZoom(15)}else if(navigator.geolocation){var i={enableHighAccuracy:!0,maximumAge:6e4,timeout:5e3};navigator.geolocation.getCurrentPosition(function(a){var b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);app.controller.sref.map.setCenter(b),app.controller.sref.map.setZoom(15)},null,i)}this.fixTabMap("#sref-opts","#map"),a("#sref-opts").enableTab(1)},fixTabMap:function(b,c){a(b).on("tabsactivate.googleMap",function(d,e){if(e.newPanel.selector==c){if(google.maps.event.trigger(app.controller.sref.map,"resize"),null!=app.controller.sref.latitude&&null!=app.controller.sref.longitude){var f=new google.maps.LatLng(app.controller.sref.latitude,app.controller.sref.longitude);app.controller.sref.map.setCenter(f),app.controller.sref.map.setZoom(15)}a(b).off("tabsactivate.googleMap")}})},gridRefConvert:function(){var b=a("#grid-ref").val(),c=OsGridRef.parse(b);if(!isNaN(c.easting)&&!isNaN(c.northing)){var d=OsGridRef.osGridToLatLon(c);this.set(d.lat,d.lon,1);var e=b.toUpperCase(),f=a("#gref-message");f.removeClass(),f.addClass("success-message"),f.empty().append("<p>Grid Ref:<br/>"+e+"</p>")}}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.tree_part={zones:{branch:[{zone:"one",title:"Zone #1"},{zone:"two",title:"Zone #2"},{zone:"three",title:"Zone #3"}],trunk:[{zone:"e",title:"East"},{zone:"s",title:"South"},{zone:"w",title:"West"}]},pagecreate:function(){_log("tree_part: pagecreate.")},pagecontainershow:function(){_log("tree_part: pagecontainershow.");var b="",c=app.storage.tmpGet(app.controller.record.TYPE),d=app.storage.tmpGet(app.controller.record.PART);switch(c){case"trunk":b="Trunk ";break;case"branch":b="Branch ";break;default:b="ERROR"}a("#tree_part_heading").text(b+d),app.controller.tree_part.setNextButton(b,c,d),app.controller.tree_part.renderButtons(c)},setNextButton:function(b,c,d){var e=a("#tree-part-next-button");e.unbind("click"),e.on("click",function(){var b=a(this).data("type"),c=a(this).data("part");app.storage.tmpSet(app.controller.record.TYPE,b),app.storage.tmpSet(app.controller.record.PART,c)}),d++<app.controller.record.types[c].length?(e.data("type",c),e.data("part",d),e.text(b+d),e.on("click",app.controller.tree_part.pagecontainershow)):(e.text("Finish"),e.on("click",function(){history.back()}))},renderButtons:function(b){var c=a("#part-template").html(),d={zone:this.zones[b]};d.trunk="trunk"==app.storage.tmpGet(app.controller.record.TYPE);var e=a("#part-placeholder"),f=Handlebars.compile(c);app.controller.tree_part.addSelectedSpecies(d),e.html(f(d)),e.trigger("create"),a("a.zone").on("click",function(){var b=a(this).data("zone");app.storage.tmpSet(app.controller.record.ZONE,b)})},addSelectedSpecies:function(a){function b(a){var b=app.controller.list.getSavedZoneSpecies(a.zone);if(b.length>0){var c=app.controller.list.categorizeSpecies(b);a.results={tolerant:c.tolerant.length,sensitive:c.sensitive.length}}else delete a.results}for(var c=0;c<a.zone.length;c++)b(a.zone[c])}}}(jQuery),function(a){app.controller=app.controller||{},app.controller.welcome={pagecreate:function(){_log("welcome: pagecreate.",app.LOG_DEBUG),a("#record-button").on("click",function(){app.storage.tmpSet(app.controller.record.RECORDING,!0)})},pagecontainershow:function(){_log("welcome: pagecontainershow",app.LOG_DEBUG),app.storage.tmpSet(app.controller.record.RECORDING,!1)}}}(jQuery),app.CONF.VERSION="0.0.2",app.CONF.NAME="lichen_app",app.CONF.HOME="lichen/",app.CONF.LOG=app.LOG_DEBUG,app.CONF.APPCACHE_LOADER_URL="sites/all/modules/iform_mobile/php/offline.php",app.auth.CONF.APPNAME="lichen",app.auth.CONF.APPSECRET="mylichen",app.auth.CONF.WEBSITE_ID=0,app.auth.CONF.SURVEY_ID=0,app.geoloc.CONF.GPS_ACCURACY_LIMIT=10,app.io.CONF.RECORD_URL="mobile/submit";var c=app.controller;c.list.CONF.SPECIES_DATA_SRC="http://192.171.199.230/lichen/serv/species",c.login.CONF.URL=Drupal.settings.basePath+"user/mobile/register",c.register.CONF.URL=c.login.CONF.URL,window.onerror=_onerror;